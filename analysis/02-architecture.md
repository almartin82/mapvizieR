# Architecture Analysis - mapvizieR

## Executive Summary

The package follows R package conventions reasonably well but shows architectural debt from organic growth. The mapvizieR object design is sound but could benefit from modernization. Separation of concerns is inconsistent across visualization functions.

## 1. Package Structure Assessment

### Current Structure

```
mapvizieR/
├── R/                      # 67 R files, 14,090 lines total
├── data/                   # Package data (sample datasets)
├── data-raw/              # Raw data and processing scripts
├── inst/
│   └── report_templates/  # Only slim_template.docx
├── man/                   # 194 documentation files
├── tests/
│   └── testthat/         # 54 test files
├── vignettes/            # 7 vignettes
├── DESCRIPTION
├── NAMESPACE
└── NEWS.md
```

### Conformance to R Package Conventions

| Convention | Status | Notes |
|------------|--------|-------|
| R/ directory | ✓ Good | All R code properly placed |
| DESCRIPTION | ⚠ Needs update | Outdated metadata, missing fields |
| NAMESPACE | ✓ Good | Generated by roxygen2 |
| man/ | ✓ Good | Complete documentation |
| tests/ | ✓ Good | Comprehensive test suite |
| vignettes/ | ⚠ Issues | May have build issues |
| inst/ | ⚠ Sparse | Only one template file |
| data/ | ✓ Good | Sample data included |
| NEWS.md | ⚠ Stale | Last entry ~2017 |

### Missing Elements

1. **No `.github/` directory**: Missing CI/CD workflows
2. **No `pkgdown` configuration**: No documentation site setup
3. **Outdated `wercker.yml`**: Deprecated CI system
4. **No `CONTRIBUTING.md`**: Missing contribution guidelines
5. **No `CODE_OF_CONDUCT.md`**: Community standards missing

## 2. mapvizieR Object Design

### Current Structure

```r
mapviz <- list(
  'cdf'       = processed_cdf,      # mapvizieR_cdf class
  'roster'    = roster,             # mapvizieR_roster class
  'growth_df' = growth_df           # mapvizieR_growth class
)
class(mapviz) <- c("mapvizieR", class(mapviz))
```

### Strengths

1. **Clear data separation**: CDF, roster, and growth are distinct
2. **S3 class hierarchy**: Proper subclasses for components
3. **print/summary methods**: Basic introspection available
4. **Constructor validation**: Uses `assertthat` for basic checks

### Weaknesses

1. **No immutability protection**: Components can be modified freely
2. **No schema validation**: Fields not enforced after construction
3. **No versioning**: Can't detect objects from older package versions
4. **Sparse accessor methods**: Direct list access encouraged

### Recommended Improvements

```r
# Add version tracking
mapviz$version <- packageVersion("mapvizieR")

# Add validation method
validate_mapvizieR <- function(x) {
  # Check required components
  # Validate each component's structure
  # Return TRUE or informative errors
}

# Add accessor methods
cdf <- function(x) UseMethod("cdf")
cdf.mapvizieR <- function(x) x$cdf

roster <- function(x) UseMethod("roster")
roster.mapvizieR <- function(x) x$roster

growth_df <- function(x) UseMethod("growth_df")
growth_df.mapvizieR <- function(x) x$growth_df
```

## 3. Separation of Concerns

### Current State

| Category | Files | Assessment |
|----------|-------|------------|
| Data Prep | `cdf_prep.R`, `roster_prep.R`, `growth_df_prep.R`, `cgp_prep.R`, `norms_prep.R` | ✓ Good separation |
| Visualization | `becca_plot.R`, `haid_plot.R`, `galloping_elephants.R`, etc. | ⚠ Mixed with data processing |
| Utilities | `util.R` (866 lines!), `plot_util.R`, `globals.R` | ⚠ util.R is too large |
| Object/Class | `mapvizieR_object.R`, `mapvizier_summary.R` | ✓ OK |
| Reporting | `report_dispatcher.R`, `templates.R`, various report files | ⚠ Tightly coupled |

### Problems Identified

1. **util.R is a dumping ground** (866 lines):
   - Contains: date parsing, validation, filtering, color helpers, timing functions
   - Should be split into: `validate.R`, `helpers.R`, `filter.R`, `colors.R`

2. **Visualization functions do too much data processing**:
   - `haid_plot()` includes significant data munging
   - `quealy_subgroups()` calculates stats AND builds plots

3. **Inconsistent data flow**:
   - Some functions take mapvizieR object
   - Some functions take individual data frames
   - Not always clear what's expected

### Recommended Refactoring

```
R/
├── data-prep/
│   ├── cdf_prep.R
│   ├── roster_prep.R
│   ├── growth_df_prep.R
│   └── norms_prep.R
├── visualization/
│   ├── becca_plot.R
│   ├── haid_plot.R
│   ├── galloping_elephants.R
│   ├── quealy_subgroups.R
│   └── goalbar.R
├── reporting/
│   ├── report_dispatcher.R
│   └── templates.R
├── object/
│   ├── mapvizieR_object.R
│   ├── mapvizieR_summary.R
│   └── mapvizieR_validate.R
└── utils/
    ├── validate.R
    ├── helpers.R
    ├── colors.R
    └── filter.R
```

## 4. DRY Principle Violations

### Repeated Code Patterns

#### 1. Data Limiting Pattern
```r
# Appears in 10+ visualization functions
this_cdf <- mv_limit_cdf(mapvizieR_obj, studentids, measurementscale)
# or
growth_df <- mv_limit_growth(mapvizieR_obj, studentids, measurementscale)
```

#### 2. Theme Construction
```r
# Similar theme code in multiple files:
# becca_plot.R:192-206
# galloping_elephants.R:104-118
# haid_plot.R:344-365
# quealy_subgroups.R:538-548

# Each builds from theme_bw() with similar overrides
theme_bw() +
theme(
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # ... similar patterns
)
```

#### 3. Color Lookup Tables
```r
# haid_plot.R:147-152
growth_colors <- data.frame(
  status = c(p_growth_tiers, NA),
  color = c(p_growth_colors, 'gray50'),
  stringsAsFactors = FALSE
)

# Similar pattern in goalbar.R:125-131
```

### Recommended Solutions

1. **Create `theme_mapvizier()`**:
   ```r
   theme_mapvizier <- function(base_size = 11) {
     theme_bw(base_size = base_size) +
     theme(
       panel.grid.major = element_blank(),
       panel.grid.minor = element_blank(),
       # ... standardized styling
     )
   }
   ```

2. **Create color palette functions**:
   ```r
   mapvizier_quartile_colors <- function() {
     c('#f3716b', '#79ac41', '#1ebdc2', '#a57eb8')
   }

   scale_fill_quartile <- function(...) {
     scale_fill_manual(values = mapvizier_quartile_colors(), ...)
   }
   ```

## 5. Theme/Styling Consistency

### Current State: Inconsistent

| Plot | Base Theme | Custom Styling | Colors |
|------|------------|----------------|--------|
| `becca_plot` | `theme_bw()` | Minimal | KIPP colors via parameter |
| `haid_plot` | Custom transparent | Extensive | Quartile + growth colors |
| `galloping_elephants` | `theme_bw()` | Moderate | Sequential Blues |
| `goalbar` | None (raw theme) | Extensive | Goal status colors |
| `quealy_subgroups` | `theme_bw()` | Moderate | Hardcoded hotpink! |

### Inconsistencies

1. **Font sizes**: Not standardized (range from 3 to 18)
2. **Axis styling**: Each plot handles differently
3. **Legend positions**: Inconsistent placement
4. **Color palettes**: No shared palette across plots

## 6. Configuration Management

### Current Approach

No centralized configuration. Each function has its own defaults:

```r
# becca_plot.R - defaults in function signature
color_scheme = 'KIPP Report Card'

# haid_plot.R - defaults in function signature
p_growth_colors = c("tan4", "snow4", "gold", "red")
p_quartile_colors = c('#f3716b', '#79ac41', '#1ebdc2', '#a57eb8')
```

### Recommended Approach

Create `R/config.R`:

```r
#' @title mapvizieR Configuration
#' @name mapvizier_config
#' @description Default configuration for mapvizieR visualizations

mapvizier_config <- list(
  colors = list(
    quartile = c('#f3716b', '#79ac41', '#1ebdc2', '#a57eb8'),
    growth_status = c("tan4", "snow4", "gold", "red"),
    kipp_report_card = c('#f3716b', '#79ac41', '#1ebdc2', '#a57eb8')
  ),
  text_sizes = list(
    title = 18,
    subtitle = 14,
    label = 11,
    annotation = 9
  ),
  themes = list(
    default = "mapvizier"
  )
)
```

## 7. Internal vs Exported Function Organization

### Current NAMESPACE Exports

- 134 exported functions (very high for a visualization package!)
- Many should be internal

### Functions That Should Be Internal

| Currently Exported | Should Be | Reason |
|-------------------|-----------|--------|
| `quartile_order()` | Internal | Helper only |
| `ensure_rows_in_df()` | Internal | Validation helper |
| `ensure_nonzero_students_with_norms()` | Internal | Validation helper |
| `round_to_any()` | Internal | Utility (also in scales pkg) |
| `peek()` | Internal | Debugging helper |
| `h_var()` | Internal | Grid helper |
| `centroid()` | Internal | Calculation helper |
| `grob_justifier()` | Internal | Grid helper |

### Recommended Export Cleanup

Reduce exports to ~50-75 user-facing functions:
- Core plotting functions
- Data prep functions
- mapvizieR object functions
- Key utility functions

## 8. Dependencies Between Visualization Functions

### Dependency Map

```
mapvizieR_object.R
    ├── cdf_prep.R
    ├── roster_prep.R
    └── growth_df_prep.R
         └── cgp_prep.R

becca_plot.R
    ├── util.R (mv_limit_cdf, valid_grade_seasons, etc.)
    └── plot_util.R

haid_plot.R
    ├── util.R (mv_limit_growth, round_to_any, etc.)
    └── goals_and_projections.R

quealy_subgroups.R
    ├── util.R
    ├── cgp_prep.R (calc_cgp)
    ├── roster_to_df.R
    └── growth_window.R
```

### Circular Dependency Risk

Currently low risk - dependencies flow mostly downward.

## 9. Report Template Architecture

### Current State

```
inst/report_templates/
└── slim_template.docx      # Only 1 template!

vignettes/
├── report_dispatcher.Rmd   # Documents dispatcher
└── templates.Rmd           # Template documentation
```

### Issues

1. **Minimal template variety**: Only one Word template
2. **No RMarkdown templates**: Could add parameterized reports
3. **Dispatcher is complex**: 185 lines, hard to extend

### Recommendations

1. Add more report templates to `inst/report_templates/`
2. Create parameterized RMarkdown templates
3. Document template creation process

## 10. API Design Consistency

### Inconsistent Parameter Names

| Concept | Variations Used |
|---------|-----------------|
| Student IDs | `studentids`, `studentid` |
| MAP Object | `mapvizieR_obj`, `mapvizier_obj` |
| Subject | `measurementscale` |
| Season | `fws`, `fallwinterspring`, `start_fws`, `end_fws` |
| Year | `academic_year`, `map_year_academic`, `start_academic_year` |

### Inconsistent Return Types

| Function | Returns |
|----------|---------|
| `becca_plot()` | ggplot object |
| `haid_plot()` | ggplot object |
| `quealy_subgroups()` | grob (not ggplot!) |
| `galloping_elephants()` | ggplot object |
| `two_pager()` | side effect (prints) |

### Recommendations

1. Standardize parameter naming
2. Document return types clearly
3. Consider wrapper for grob-returning functions

## Summary: Architecture Priorities

### Priority 1
1. Split `util.R` into focused modules
2. Create centralized theme/color configuration
3. Reduce exports to user-facing functions only

### Priority 2
1. Add validation to mapvizieR object
2. Standardize API parameter names
3. Document dependencies clearly

### Priority 3
1. Improve report template infrastructure
2. Add accessor methods to mapvizieR object
3. Consider reorganizing R/ directory structure
